<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>yahvk's blog - reverseengineering</title><link href="https://blog.yahvk.ml/" rel="alternate"></link><link href="https://blog.yahvk.ml/feeds/reverseengineering.atom.xml" rel="self"></link><id>https://blog.yahvk.ml/</id><updated>2021-08-05T14:19:52+08:00</updated><entry><title>修复土豆文解码器</title><link href="https://blog.yahvk.ml/xiu-fu-tu-dou-wen-jie-ma-qi.html" rel="alternate"></link><published>2021-08-05T14:19:52+08:00</published><updated>2021-08-05T14:19:52+08:00</updated><author><name>yahvk</name></author><id>tag:blog.yahvk.ml,2021-08-05:/xiu-fu-tu-dou-wen-jie-ma-qi.html</id><summary type="html">整理硬盘时，在硬盘中翻到了多年前在 &lt;a href="https://www.keyfc.net"&gt;KeyFC&lt;/a&gt; 下载的&lt;a href="https://www.keyfc.net/bbs/showtopic-25834.aspx"&gt;土豆文&lt;/a&gt;套件，
随着 Windows 系统的不断更新，土豆文解码器的登录检测已经无法正常工作了。</summary><content type="html">&lt;p&gt;整理硬盘时，在硬盘中翻到了多年前在 &lt;a href="https://www.keyfc.net"&gt;KeyFC&lt;/a&gt; 下载的&lt;a href="https://www.keyfc.net/bbs/showtopic-25834.aspx"&gt;土豆文&lt;/a&gt;套件，
随着 Windows 系统的不断更新，土豆文解码器的登录检测已经无法正常工作了。&lt;/p&gt;
&lt;div&gt;
土豆星星歌附上
&lt;audio autoplay loop controls&gt;
  &lt;source src="https://blog.yahvk.ml/audio/tudou.opus" type="audio/ogg; codecs=opus"/&gt;
  &lt;source src="https://blog.yahvk.ml/audio/tudou.mp3" type="audio/mpeg"/&gt;
  &lt;p&gt;看起来你的浏览器听不到呢，&lt;a href="https://blog.yahvk.ml/audio/tudou.mp3"&gt;链接在这里&lt;/a&gt;&lt;/p&gt;
&lt;/audio&gt;
&lt;/div&gt;

&lt;h2&gt;KeyFC&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://www.keyfc.net"&gt;KeyFC&lt;/a&gt; 是个超级有爱的论坛~&lt;/p&gt;
&lt;p&gt;多年前路过 KFC，神秘的土豆文吸引了我。我下载了土豆文套件，玩了一会儿，但玩过了也就好了，于是土豆文套件便被我尘封在了硬盘的角落里。
当时也只是路过，甚至都不知道 Key 社是什么，所以玩过土豆文之后，也再没访问过 KFC。&lt;/p&gt;
&lt;p&gt;过了多年，我整理硬盘时看到了硬盘角落中的土豆文套件，我试图找出这是什么，最终重新找到了 KFC。
已经看完 CLANNAD 的我再次回到 KFC……&lt;span style="font-size:0.6em"&gt;然而最吸引我的还是土豆文&lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;土豆文&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;土豆文是蕴含了世界发展底层规律的远古先进语言，其真正来源已不可考。
土豆文不是文字，而是一种规律。
土豆文不通过文字本身表达意思，而通过字符的排列规律展现其含义。
现代科学研究认为，土豆文主要展现了以下规律：
1. 叠加。事物之间没有明显的边界，对与错，好与坏，阴与阳等总是相互纠缠在一起，不停的复制叠加成为不同的繁复形态。
2. 相似。事物之间有普遍的相似性，不仅表现在事物之间的相似，也表现在局部与整体的相似，过去与未来的相似
3. 同源。 复杂的甚至是对立的事物，同样是由初始的最简单的某种元素，根据叠加与相似的规律发展而成。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;https://www.keyfc.net/bbs/showtopic-22242.aspx&lt;/p&gt;
&lt;p&gt;总之，土豆文就是一种对文字的编码，长这样：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;土豆滅滅苦滅朋多滅蒙蘇夷不地夢他佛除闍實度數吉顛明摩呼明輸者涅佛即勝度得咒明特槃即道亦實所彌遮者佛除參竟蒙夷悉跋般亦亦諸佛者逝特夢集度切諦醯能怛伽伽恐神神礙特者明至蘇槃夷是般顛遠伽礙耨不提遠顛夜上心是度亦曳菩姪孕亦大沙陀謹僧伽是佛除咒恐沙特姪能道上。遠無參佛心竟大度是參知迦能道上。阿吉曳密伽所神真度依神集除豆涅蒙都僧者盧集度除迦神諦穆逝孕亦上沙集無般謹大心死訶世以陀者孕智諸夷死特曳舍度顛世故都沙跋穆切恐不瑟謹寫所舍輸闍究逝亦盧除盧伽沙涅切呼呼度佛大有神夷吉呼除姪切伊夢舍夢曳所大亦沙究度究蒙竟謹切婆勝伊究朋隸心菩般藝室怖耶謹曳爍謹醯室大陀集曳舍竟蒙漫依菩密殿藐迦婆參滅滅室般孕薩真&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;登录&lt;/h2&gt;
&lt;p&gt;土豆文解码器启动后将先验证是否在 KeyFC 登录，从对土豆文的相关介绍来看，他回去读取 IE 的 cookie，但是怎么读取呢？&lt;/p&gt;
&lt;p&gt;上火绒剑！&lt;/p&gt;
&lt;p&gt;&lt;img alt="火绒剑界面" src="https://blog.yahvk.ml/images/tudou-1.webp"&gt;&lt;/p&gt;
&lt;p&gt;从火绒剑分析得到，它调用了 wininet 的 &lt;a href="https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetgetcookiea"&gt;InternetGetCookieA&lt;/a&gt; 函数。
但是用 IE11 登录 KFC 并不能让解码器登录，大概是 IE11 已经不用这套函数了。&lt;/p&gt;
&lt;p&gt;继续研究 wininet 的文档，找到了另一个函数 &lt;a href="https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetsetcookiea"&gt;InternetSetCookieA&lt;/a&gt;。
那么推测只要用 InternetSetCookieA 设置了 Cookie，就可以使解码器登录了。&lt;/p&gt;
&lt;p&gt;写了个 Powershell 脚本设置了 Cookie，但是并没有成功（实际上是复制时漏了字符），上 OD！&lt;/p&gt;
&lt;h2&gt;脱壳&lt;/h2&gt;
&lt;p&gt;为了找出解码器的具体工作原理，我决定反编译。&lt;/p&gt;
&lt;p&gt;PEiD 查壳 &lt;code&gt;PECompact 2.x&lt;/code&gt;，esp 定律后单步跟踪到 &lt;code&gt;0053C715 jmp eax&lt;/code&gt;，顺利找到 oep 004c7618。&lt;/p&gt;
&lt;p&gt;&lt;img alt="jmp eax" src="https://blog.yahvk.ml/images/tudou-2.webp"&gt;
&lt;img alt="oep" src="https://blog.yahvk.ml/images/tudou-3.webp"&gt;&lt;/p&gt;
&lt;p&gt;脱完壳后运行显示 &lt;code&gt;无法定位程序输入点 MtdllDefWindowProc_A&lt;/code&gt;，
依照 https://reverseengineering.stackexchange.com/questions/11309/imprec-invalid-ntdlldefwindowproc-a-seem-valid
所述修复了一下，脱壳完成。&lt;/p&gt;
&lt;h2&gt;探索&lt;/h2&gt;
&lt;p&gt;由前面所述，解码器使用的是 &lt;code&gt;InternetGetCookieA&lt;/code&gt; 函数，直接 OD 打断点在 &lt;code&gt;InternetGetCookieA&lt;/code&gt; 上。
跟踪一下，发现它实际上只读取了 &lt;code&gt;dnt&lt;/code&gt; 这一个 cookie，然后发现了我复制 Cookie 时的错误……&lt;/p&gt;
&lt;p&gt;&lt;img alt="OD界面" src="https://blog.yahvk.ml/images/tudou-4.webp"&gt;&lt;/p&gt;
&lt;h2&gt;完成&lt;/h2&gt;
&lt;p&gt;土豆文解码器会使用 &lt;code&gt;InternetGetCookieA&lt;/code&gt; 轮询 &lt;code&gt;http://www.KeyFC.net&lt;/code&gt; 的 Cookie，从中提取出 &lt;code&gt;dnt&lt;/code&gt; 的值。
&lt;code&gt;dnt&lt;/code&gt; 的值形如 &lt;code&gt;userid=&amp;lt;userid&amp;gt;&amp;amp;password=&amp;lt;encoded password&amp;gt;&amp;amp;...&lt;/code&gt;，根据我的观察，解码器实际上只提前了其中 userid 的值。&lt;/p&gt;
&lt;p&gt;最后我用 powershell 做了一个登录器：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nv"&gt;$source&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="sh"&gt;@&amp;quot;&lt;/span&gt;
&lt;span class="sh"&gt;using System.Runtime.InteropServices;&lt;/span&gt;
&lt;span class="sh"&gt;using System;&lt;/span&gt;
&lt;span class="sh"&gt;namespace Cookies&lt;/span&gt;
&lt;span class="sh"&gt;{&lt;/span&gt;
&lt;span class="sh"&gt;    public static class setter&lt;/span&gt;
&lt;span class="sh"&gt;    {&lt;/span&gt;
&lt;span class="sh"&gt;        [DllImport(&amp;quot;wininet.dll&amp;quot;, CharSet = CharSet.Auto, SetLastError = true)]&lt;/span&gt;
&lt;span class="sh"&gt;        private static extern bool InternetSetCookie(string url, string name, string data);&lt;/span&gt;

&lt;span class="sh"&gt;        public static bool SetWinINETCookieString(string url, string name, string data)&lt;/span&gt;
&lt;span class="sh"&gt;        {&lt;/span&gt;
&lt;span class="sh"&gt;            bool res = setter.InternetSetCookie(url, name, data);&lt;/span&gt;
&lt;span class="sh"&gt;            if (!res)&lt;/span&gt;
&lt;span class="sh"&gt;            {&lt;/span&gt;
&lt;span class="sh"&gt;                throw new Exception(&amp;quot;Exception setting cookie: Win32 Error code=&amp;quot;+Marshal.GetLastWin32Error());&lt;/span&gt;
&lt;span class="sh"&gt;            }else{&lt;/span&gt;
&lt;span class="sh"&gt;                return res;&lt;/span&gt;
&lt;span class="sh"&gt;            }&lt;/span&gt;
&lt;span class="sh"&gt;        }&lt;/span&gt;
&lt;span class="sh"&gt;    }&lt;/span&gt;
&lt;span class="sh"&gt;}&lt;/span&gt;
&lt;span class="sh"&gt;&amp;quot;@&lt;/span&gt;

&lt;span class="nb"&gt;Add-Type&lt;/span&gt; &lt;span class="n"&gt;-TypeDefinition&lt;/span&gt; &lt;span class="nv"&gt;$source&lt;/span&gt; &lt;span class="n"&gt;-Language&lt;/span&gt; &lt;span class="n"&gt;CSharp&lt;/span&gt;

&lt;span class="no"&gt;[DateTime]&lt;/span&gt;&lt;span class="nv"&gt;$dateTime&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;Get-Date&lt;/span&gt;
&lt;span class="nv"&gt;$str&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="nv"&gt;$dateTime&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddDays&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;30&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;ToString&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;R&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="nv"&gt;$dnt&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;Read-Host&lt;/span&gt; &lt;span class="n"&gt;-Prompt&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;请输入 Cookie dnt 的值&amp;#39;&lt;/span&gt;
&lt;span class="nv"&gt;$dnt&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="nv"&gt;$dnt&lt;/span&gt; &lt;span class="o"&gt;-replace&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;^(dnt)?\s*:?\s*&amp;quot;?&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
&lt;span class="nv"&gt;$dnt&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="nv"&gt;$dnt&lt;/span&gt; &lt;span class="o"&gt;-replace&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;quot;$&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;

&lt;span class="no"&gt;[Cookies.setter]&lt;/span&gt;&lt;span class="p"&gt;::&lt;/span&gt;&lt;span class="n"&gt;SetWinINETCookieString&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;http://www.keyfc.net&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;dnt&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;$dnt;Expires=$str&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;之后大概会做个 Qt 版的发 KFC 上。&lt;/p&gt;</content><category term="reverseengineering"></category><category term="reverseengineering"></category></entry><entry><title>破解课后网</title><link href="https://blog.yahvk.ml/po-jie-ke-hou-wang.html" rel="alternate"></link><published>2020-04-17T09:32:01+08:00</published><updated>2020-04-17T09:32:01+08:00</updated><author><name>yahvk</name></author><id>tag:blog.yahvk.ml,2020-04-17:/po-jie-ke-hou-wang.html</id><summary type="html">疫情期间在家上网课，我们学校用的是&lt;a href="https://www.kehou.com/"&gt;课后网&lt;/a&gt;。
为了能在网课上摸鱼，我就破解了课后网。</summary><content type="html">&lt;p&gt;疫情期间在家上网课，我们学校用的是&lt;a href="https://www.kehou.com/"&gt;课后网&lt;/a&gt;。
为了能在网课上摸鱼，我就破解了课后网。&lt;/p&gt;
&lt;h2&gt;防止摸鱼&lt;/h2&gt;
&lt;p&gt;在课后网中每节课都有这么一个表格&lt;/p&gt;
&lt;p&gt;&lt;img alt="家长督学界面" src="https://blog.yahvk.ml/images/kehou-1.webp"&gt;&lt;/p&gt;
&lt;p&gt;我的目的就是让认真度为 100%&lt;/p&gt;
&lt;h3&gt;签到&lt;/h3&gt;
&lt;p&gt;在上课过程中，软件会随机跳出签到按钮，有 20 秒的签到时间，超时就算作未签到。
一般一节课会有 2 次签到。&lt;/p&gt;
&lt;h3&gt;认真度&lt;/h3&gt;
&lt;p&gt;&lt;img alt="认真度规则" src="https://blog.yahvk.ml/images/kehou-2.webp"&gt;&lt;/p&gt;
&lt;p&gt;认真度主要受在线时间、「认真时间」和上文所说签到次数的影响。&lt;/p&gt;
&lt;p&gt;「认真时间」app 内没有给出解释，经过实测，切出 app 后是不认真时间，只要让 app 在前台就算是认真。&lt;/p&gt;
&lt;h3&gt;锁屏&lt;/h3&gt;
&lt;p&gt;Windows 端的课后网程序会不断的获取焦点来让自己显示在最上方，影响其它程序的使用。&lt;/p&gt;
&lt;h2&gt;破解一：反编译 apk&lt;/h2&gt;
&lt;p&gt;最初，我认为 apk 的反编译会比 Windows 的简单很多，所以我就对 apk 下手了。&lt;/p&gt;
&lt;p&gt;没有反编译经验，这里的反编译流程是我自己 google 研究出来的，不一定是最好的。&lt;/p&gt;
&lt;p&gt;我当时用的课后网的 apk 传到 mega 上了：&lt;a href="https://mega.nz/file/8HAg1YpS#odqb6VBz6j3jQdeYEK1CstimutTu2tdEGeq_6Vf9LjE"&gt;https://mega.nz/file/8HAg1YpS#odqb6VBz6j3jQdeYEK1CstimutTu2tdEGeq_6Vf9LjE&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;反编译&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;apktool d kehou.apk -o kehou-apktool &lt;span class="c1"&gt;# 解包 kehou.apk 到 kehou-apktool&lt;/span&gt;
d2j-dex2jar kehou.apk &lt;span class="c1"&gt;# 提取 kehou.apk 代码为 jar&lt;/span&gt;
jadx kehou-dex2jar.jar &lt;span class="c1"&gt;# 把上一步提取出的 jar 反编译为 java 代码放在 kehou-dex2jar/sources/&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;修改代码&lt;/h3&gt;
&lt;h4&gt;签到&lt;/h4&gt;
&lt;p&gt;反编译完了就可以找代码了，在 kehou-apktool/res &lt;code&gt;rg 签到&lt;/code&gt; 找到了一个叫做 &lt;strong&gt;rollcall_confirm&lt;/strong&gt; 的 layout。&lt;/p&gt;
&lt;p&gt;再在 kehou-dex2jar/sources/ &lt;code&gt;rg rollcall&lt;/code&gt; 找到了签到主要在
&lt;code&gt;vizpower/imeeting/RollCallMgr.java&lt;/code&gt; 和 &lt;code&gt;vizpower/imeeting/viewcontroller/RollcallConfirmViewController.java&lt;/code&gt; 两个文件。&lt;/p&gt;
&lt;p&gt;对代码一番研究后找出当签到开始时会调用 &lt;code&gt;RollcallConfirmViewController#onStartRollcallConfirm&lt;/code&gt;，
点击签到按钮后会调用 &lt;code&gt;RollcallConfirmViewController#onBtnClickRollcallConfirm&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;所以只要在 &lt;code&gt;onStartRollcallConfirm&lt;/code&gt; 中调用 &lt;code&gt;onBtnClickRollcallConfirm&lt;/code&gt;，就可以在开始签到的时候自动签到了。&lt;/p&gt;
&lt;p&gt;然后我还在 &lt;code&gt;onBtnClickRollcallConfirm&lt;/code&gt; 加了个提示：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;Toast&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="na"&gt;makeText&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="na"&gt;m_pIMainActivity&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getActivity&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;已自动签到&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Toast&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="na"&gt;LENGTH_LONG&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="na"&gt;show&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h4&gt;认真度&lt;/h4&gt;
&lt;p&gt;由上一步可以看出来所有课后网自己的代码都在 vizpower 中，直播课相关的内容在 vizpower/imeeting。&lt;/p&gt;
&lt;p&gt;由「认真时间」的计算方法可以推断逻辑是写在 &lt;code&gt;onPause&lt;/code&gt; 回调内，直接在 vizpower/imeeting &lt;code&gt;rg onPause -A5&lt;/code&gt;，找出这部分代码在 &lt;code&gt;MainActivity.java&lt;/code&gt; 中。&lt;/p&gt;
&lt;p&gt;「认真时间」的计算来自于 Timer 发的心跳包，这个 Timer 在 &lt;code&gt;onPause&lt;/code&gt; 停止，在 &lt;code&gt;onResume&lt;/code&gt; 中恢复。
在 &lt;code&gt;onPause&lt;/code&gt; 中把停止 Timer 的 &lt;code&gt;DesktopShareMgr.getInstance().stopDSTimer();&lt;/code&gt; 这一行注释掉就可以一直「认真」了。&lt;/p&gt;
&lt;h3&gt;编译回 apk&lt;/h3&gt;
&lt;p&gt;需要 Android SDK，编译出 class 文件：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;javac -cp /opt/android-sdk/platforms/android-29/android.jar:.../kehou-dex2jar.jar &amp;lt;edited files&amp;gt; &lt;span class="c1"&gt;# 把 android.jar 和 kehou-dex2jar.jar 的路径换成你自己的&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;把编译出来的 class 文件按原来的目录组织起来，我放在 inject/source 下，然后编译出 dex 文件，再反编译为 smali 文件：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;dx --dex --output&lt;span class="o"&gt;=&lt;/span&gt;classes.dex &lt;span class="nb"&gt;source&lt;/span&gt;
d2j-baksmali classes.dex
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;然后用这些 smali 替换掉 apktool 解出来的 smali 文件，然后用 apktool 打包，再签名。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;apktool b kehou-apktool
&lt;span class="nb"&gt;cd&lt;/span&gt; kehou-apktool/dist/
d2j-apk-sign kehou.apk
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;附注&lt;/h3&gt;
&lt;p&gt;有一些文件内有部分无法反编译的代码，这时用上一节的方法就不行了，
这时要找出对应的函数，只把编译出的对应函数的 smali 代码覆盖过去，而不是所有文件。&lt;/p&gt;
&lt;p&gt;也可以直接编辑 apktool 解出来的 smali 文件，我后来就是这么做的。
但是有时候直接改 smali 代码，大概是改出了些问题，app 执行到那部分代码时会崩溃，这时还是用上一节的方法吧。&lt;/p&gt;
&lt;h2&gt;破解二：辅助功能&lt;/h2&gt;
&lt;p&gt;在一次强制更新后，课后的 app 使用了 360 加固，破解一失效。&lt;/p&gt;
&lt;p&gt;我想到了抢红包的原理，于是我找到了&lt;a href="https://www.jianshu.com/p/e1099a94b979"&gt;《Android 通过辅助功能实现抢微信红包原理简单介绍》&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;这段暂略……&lt;/p&gt;
&lt;h2&gt;破解三：修改网络流量&lt;/h2&gt;
&lt;p&gt;以为破解二不能破解「认真时间」，所以上课时间这台手机就用不了了，我对此并不满意。
这次我把目标转移到了 PC 端上。&lt;/p&gt;
&lt;p&gt;首先，因为锁屏和我使用 Linux 的需求，我就把课后网装到了虚拟机上。&lt;/p&gt;
&lt;p&gt;反编译 native code 的程序难度太大了，所以很容易想到从网络入手。&lt;/p&gt;
&lt;p&gt;代码：&lt;a href="https://gitlab.com/71e6fd52/kehou_proxy"&gt;https://gitlab.com/71e6fd52/kehou_proxy&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;通讯协议&lt;/h3&gt;
&lt;p&gt;我用的 VirtualBox 自带抓包功能：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;mkfifo /tmp/file.pcap
VBoxManage modifyvm vm1 --nictrace1 on --nictracefile1 /tmp/file.pcap
wireshark -k -i /tmp/file.pcap &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;但是看抓出的包并不容易看出来，只能看出通讯在 9980 端口上，这时破解一中反编译的源代码就派上了用场。&lt;/p&gt;
&lt;p&gt;经过对源代码的分析可以看出包的格式为 &lt;code&gt;0x02 0x02 &amp;lt;后面的长度:i16&amp;gt; 0x01 &amp;lt;命令号:i16&amp;gt; &amp;lt;内容&amp;gt;&lt;/code&gt;，
所有数字为小端。&lt;/p&gt;
&lt;p&gt;所有命令在 vizpower/mtmgr/PDU 下，如 &lt;code&gt;ReplyNaming&lt;/code&gt; 的命令号为 -32206(0x32 0x82)，内容由&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;byte&lt;/span&gt; &lt;span class="n"&gt;bTime&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="kt"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;dwUserID&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="n"&gt;byteBuffer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="na"&gt;putInt&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="na"&gt;dwUserID&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="n"&gt;byteBuffer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="na"&gt;bTime&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;可见先是 i32 的 dwUserID，然后是 i8 的 bTime。&lt;/p&gt;
&lt;p&gt;再看一下调用的代码可以看出来 dwUserID 是加入课堂时会由 &lt;code&gt;NotifyJoinMeeting&lt;/code&gt;(-32254) 分配的 ID，
bTime 是签到所花的秒数。&lt;/p&gt;
&lt;h3&gt;修改网络&lt;/h3&gt;
&lt;p&gt;先要让网络经过 nftable，我最初用的是 arp 攻击，后来直接让主机作为虚拟机的网关。&lt;/p&gt;
&lt;p&gt;建一个 tap，此处虚拟机网段为 192.168.2.0/24 ：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;ip tuntap add dev tap0 mode tap user &lt;span class="nv"&gt;$USER&lt;/span&gt;
ip addr add &lt;span class="m"&gt;192&lt;/span&gt;.168.2.1/24 scope link dev tap0
ip link &lt;span class="nb"&gt;set&lt;/span&gt; tap0 up
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;虚拟机设置为桥接网络，桥接在 tap0 上。&lt;/p&gt;
&lt;p&gt;在把所有发往 9980 的端口劫持了（以主机地址为 192.168.1.200 为例）：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;table ip nat {
  chain prerouting {
    type nat hook prerouting priority 0;
    ip saddr 192.168.2.0/24 tcp dport 9980 dnat to 192.168.1.200;
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;接下来再在主机上启动一个监听 9980 端口的程序，并把收到的数据（做些修改的）转发到课后网的服务器上。
这个程序在收到 &lt;code&gt;NotifyJoinMeeting&lt;/code&gt;(-32254) 时记录下 UserID，
在收到 &lt;code&gt;RequestNaming&lt;/code&gt;(-32207) 时回复 &lt;code&gt;ReplyNaming&lt;/code&gt;(-32206)。&lt;/p&gt;
&lt;h3&gt;获取 ip&lt;/h3&gt;
&lt;p&gt;上一节所说的中间程序需要连接到课后网的服务器上，但是据我观察，课后网的服务器地址每节课是不一样的。&lt;/p&gt;
&lt;p&gt;所以我就加了一个程序，抓取课后网试图连接的服务器的 ip 地址发送给这个中间程序，这就是我的代码中 &lt;code&gt;pcap_server.rb&lt;/code&gt; 的用处。&lt;/p&gt;</content><category term="reverseengineering"></category><category term="kehou"></category></entry></feed>