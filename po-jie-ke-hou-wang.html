<!doctype html>
<html lang="zh" itemscope itemtype="https://schema.org/Person">
<head>
        <meta charset="utf-8">
        <!-- Site Meta Data -->
        <title>破解课后网</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="yahvk">

        <link rel="shortcut icon" href="https://blog.yahvk.ml/favicon.ico">

        <!-- schema.org -->
        <meta itemprop="name" content="yahvk's blog">
        <meta itemprop="image" content="">
        <meta itemprop="description" content="">

        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
        <!-- Style Meta Data -->
        <link rel="stylesheet" href="https://blog.yahvk.ml/theme/css/style.css" type="text/css"/>
        <link rel="stylesheet" href="https://blog.yahvk.ml/theme/css/pygments.css" type="text/css"/>

        <!-- Feed Meta Data -->
            <link href="https://blog.yahvk.ml/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
                  title="yahvk's blog ATOM Feed"/>

        <!-- Twitter Feed -->
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="yahvk_cuna">
        <meta name="twitter:image" content="">

  <meta name="twitter:creator" content="yahvk_cuna">
  <meta name="twitter:url" content="https://blog.yahvk.ml/po-jie-ke-hou-wang.html">
  <meta name="twitter:title" content="yahvk's blog ~ 破解课后网">
  <meta name="twitter:description" content="疫情期间在家上网课，我们学校用的是课后网。 为了能在网课上摸鱼，我就破解了课后网。">

  <!-- simpread Meta Data -->
  <meta name="simpread:name" content="https://blog.yahvk.ml">
  <meta name="simpread:title" content="<h2>">
  <meta name="simpread:desc" content>
  <meta name="simpread:include" content="<div class='entry-content'>">

  <!-- Facebook Meta Data -->
  <meta property="og:title" content="yahvk's blog ~ 破解课后网"/>
  <meta property="og:description" content="疫情期间在家上网课，我们学校用的是课后网。 为了能在网课上摸鱼，我就破解了课后网。"/>
  <meta property="og:image" content=""/>
  <link rel="stylesheet" href="https://blog.yahvk.ml/theme/css/comment.css" type="text/css"/>
</head>

<body>
<!-- Sidebar -->
<aside>
    <!--<center><a href="https://blog.yahvk.ml"><img id="avatar" src=""></a></center>-->
    <h1><a href="https://blog.yahvk.ml" style="text-decoration: inherit; color: inherit;">yahvk's blog</a></h1>
    <br>

        <a class="twitter-follow-button"
           href="https://twitter.com/yahvk_cuna"
           data-show-count="false"
           data-lang="en">
            Follow @twitterdev
        </a>
        <script type="text/javascript">
            window.twttr = (function (d, s, id) {
                var t, js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s);
                js.id = id;
                js.src = "https://platform.twitter.com/widgets.js";
                fjs.parentNode.insertBefore(js, fjs);
                return window.twttr || (t = {
                        _e: [], ready: function (f) {
                            t._e.push(f)
                        }
                    });
            }(document, "script", "twitter-wjs"));
        </script>

    <nav class="nav">
        <ul class="list-bare">



        </ul>
    </nav>

    <p class="social">
                <a href="https://github.com/71e6fd52" target="_blank"><img
                        src="https://blog.yahvk.ml/theme/images/icons/github.png"></a>
                <a href="https://twitter.com/yahvk_cuna" target="_blank"><img
                        src="https://blog.yahvk.ml/theme/images/icons/twitter.png"></a>
                <a href="mailto:71e6fd52@gmail.com" target="_blank"><img
                        src="https://blog.yahvk.ml/theme/images/icons/mail-s.png"></a>
            <a href="https://blog.yahvk.ml/feeds/all.atom.xml" rel="alternate">
                <img src="https://blog.yahvk.ml/theme/images/icons/rss.png"></a>
    </p>

        <h2>Categories</h2>
        <ul class="navbar">
                <li><a
                        href="https://blog.yahvk.ml/category/pelican.html">Pelican</a></li>
                <li><a
                        href="https://blog.yahvk.ml/category/peokeemei.html">PEOKEEMEI</a></li>
                <li><a
                        href="https://blog.yahvk.ml/category/program.html">program</a></li>
                <li class="active"><a
                        href="https://blog.yahvk.ml/category/reverseengineering.html">reverseengineering</a></li>
                <li><a
                        href="https://blog.yahvk.ml/category/windows.html">Windows</a></li>
        </ul>


</aside>

<!-- Content -->
<article>
<section id="content">
  <article>
    <h2 class="post_title post_detail">
      <a href="https://blog.yahvk.ml/po-jie-ke-hou-wang.html" rel="bookmark" title="Permalink to 破解课后网">破解课后网</a>
    </h2>

    <div class="entry-content blog-post">
      <p>疫情期间在家上网课，我们学校用的是<a href="https://www.kehou.com/">课后网</a>。
为了能在网课上摸鱼，我就破解了课后网。</p>
<h2>防止摸鱼</h2>
<p>在课后网中每节课都有这么一个表格</p>
<p><img alt="家长督学界面" src="https://blog.yahvk.ml/images/kehou-1.webp"></p>
<p>我的目的就是让认真度为 100%</p>
<h3>签到</h3>
<p>在上课过程中，软件会随机跳出签到按钮，有 20 秒的签到时间，超时就算作未签到。
一般一节课会有 2 次签到。</p>
<h3>认真度</h3>
<p><img alt="认真度规则" src="https://blog.yahvk.ml/images/kehou-2.webp"></p>
<p>认真度主要受在线时间、「认真时间」和上文所说签到次数的影响。</p>
<p>「认真时间」app 内没有给出解释，经过实测，切出 app 后是不认真时间，只要让 app 在前台就算是认真。</p>
<h3>锁屏</h3>
<p>Windows 端的课后网程序会不断的获取焦点来让自己显示在最上方，影响其它程序的使用。</p>
<h2>破解一：反编译 apk</h2>
<p>最初，我认为 apk 的反编译会比 Windows 的简单很多，所以我就对 apk 下手了。</p>
<p>没有反编译经验，这里的反编译流程是我自己 google 研究出来的，不一定是最好的。</p>
<p>我当时用的课后网的 apk 传到 mega 上了：<a href="https://mega.nz/file/8HAg1YpS#odqb6VBz6j3jQdeYEK1CstimutTu2tdEGeq_6Vf9LjE">https://mega.nz/file/8HAg1YpS#odqb6VBz6j3jQdeYEK1CstimutTu2tdEGeq_6Vf9LjE</a></p>
<h3>反编译</h3>
<div class="highlight"><pre><span></span><code>apktool d kehou.apk -o kehou-apktool <span class="c1"># 解包 kehou.apk 到 kehou-apktool</span>
d2j-dex2jar kehou.apk <span class="c1"># 提取 kehou.apk 代码为 jar</span>
jadx kehou-dex2jar.jar <span class="c1"># 把上一步提取出的 jar 反编译为 java 代码放在 kehou-dex2jar/sources/</span>
</code></pre></div>

<h3>修改代码</h3>
<h4>签到</h4>
<p>反编译完了就可以找代码了，在 kehou-apktool/res <code>rg 签到</code> 找到了一个叫做 <strong>rollcall_confirm</strong> 的 layout。</p>
<p>再在 kehou-dex2jar/sources/ <code>rg rollcall</code> 找到了签到主要在
<code>vizpower/imeeting/RollCallMgr.java</code> 和 <code>vizpower/imeeting/viewcontroller/RollcallConfirmViewController.java</code> 两个文件。</p>
<p>对代码一番研究后找出当签到开始时会调用 <code>RollcallConfirmViewController#onStartRollcallConfirm</code>，
点击签到按钮后会调用 <code>RollcallConfirmViewController#onBtnClickRollcallConfirm</code>。</p>
<p>所以只要在 <code>onStartRollcallConfirm</code> 中调用 <code>onBtnClickRollcallConfirm</code>，就可以在开始签到的时候自动签到了。</p>
<p>然后我还在 <code>onBtnClickRollcallConfirm</code> 加了个提示：</p>
<div class="highlight"><pre><span></span><code><span class="n">Toast</span><span class="p">.</span><span class="na">makeText</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">m_pIMainActivity</span><span class="p">.</span><span class="na">getActivity</span><span class="p">(),</span> <span class="s">&quot;已自动签到&quot;</span><span class="p">,</span> <span class="n">Toast</span><span class="p">.</span><span class="na">LENGTH_LONG</span><span class="p">).</span><span class="na">show</span><span class="p">();</span>
</code></pre></div>

<h4>认真度</h4>
<p>由上一步可以看出来所有课后网自己的代码都在 vizpower 中，直播课相关的内容在 vizpower/imeeting。</p>
<p>由「认真时间」的计算方法可以推断逻辑是写在 <code>onPause</code> 回调内，直接在 vizpower/imeeting <code>rg onPause -A5</code>，找出这部分代码在 <code>MainActivity.java</code> 中。</p>
<p>「认真时间」的计算来自于 Timer 发的心跳包，这个 Timer 在 <code>onPause</code> 停止，在 <code>onResume</code> 中恢复。
在 <code>onPause</code> 中把停止 Timer 的 <code>DesktopShareMgr.getInstance().stopDSTimer();</code> 这一行注释掉就可以一直「认真」了。</p>
<h3>编译回 apk</h3>
<p>需要 Android SDK，编译出 class 文件：</p>
<div class="highlight"><pre><span></span><code>javac -cp /opt/android-sdk/platforms/android-29/android.jar:.../kehou-dex2jar.jar &lt;edited files&gt; <span class="c1"># 把 android.jar 和 kehou-dex2jar.jar 的路径换成你自己的</span>
</code></pre></div>

<p>把编译出来的 class 文件按原来的目录组织起来，我放在 inject/source 下，然后编译出 dex 文件，再反编译为 smali 文件：</p>
<div class="highlight"><pre><span></span><code>dx --dex --output<span class="o">=</span>classes.dex <span class="nb">source</span>
d2j-baksmali classes.dex
</code></pre></div>

<p>然后用这些 smali 替换掉 apktool 解出来的 smali 文件，然后用 apktool 打包，再签名。</p>
<div class="highlight"><pre><span></span><code>apktool b kehou-apktool
<span class="nb">cd</span> kehou-apktool/dist/
d2j-apk-sign kehou.apk
</code></pre></div>

<h3>附注</h3>
<p>有一些文件内有部分无法反编译的代码，这时用上一节的方法就不行了，
这时要找出对应的函数，只把编译出的对应函数的 smali 代码覆盖过去，而不是所有文件。</p>
<p>也可以直接编辑 apktool 解出来的 smali 文件，我后来就是这么做的。
但是有时候直接改 smali 代码，大概是改出了些问题，app 执行到那部分代码时会崩溃，这时还是用上一节的方法吧。</p>
<h2>破解二：辅助功能</h2>
<p>在一次强制更新后，课后的 app 使用了 360 加固，破解一失效。</p>
<p>我想到了抢红包的原理，于是我找到了<a href="https://www.jianshu.com/p/e1099a94b979">《Android 通过辅助功能实现抢微信红包原理简单介绍》</a>。</p>
<p>这段暂略……</p>
<h2>破解三：修改网络流量</h2>
<p>以为破解二不能破解「认真时间」，所以上课时间这台手机就用不了了，我对此并不满意。
这次我把目标转移到了 PC 端上。</p>
<p>首先，因为锁屏和我使用 Linux 的需求，我就把课后网装到了虚拟机上。</p>
<p>反编译 native code 的程序难度太大了，所以很容易想到从网络入手。</p>
<p>代码：<a href="https://gitlab.com/71e6fd52/kehou_proxy">https://gitlab.com/71e6fd52/kehou_proxy</a></p>
<h3>通讯协议</h3>
<p>我用的 VirtualBox 自带抓包功能：</p>
<div class="highlight"><pre><span></span><code>mkfifo /tmp/file.pcap
VBoxManage modifyvm vm1 --nictrace1 on --nictracefile1 /tmp/file.pcap
wireshark -k -i /tmp/file.pcap <span class="p">&amp;</span>
</code></pre></div>

<p>但是看抓出的包并不容易看出来，只能看出通讯在 9980 端口上，这时破解一中反编译的源代码就派上了用场。</p>
<p>经过对源代码的分析可以看出包的格式为 <code>0x02 0x02 &lt;后面的长度:i16&gt; 0x01 &lt;命令号:i16&gt; &lt;内容&gt;</code>，
所有数字为小端。</p>
<p>所有命令在 vizpower/mtmgr/PDU 下，如 <code>ReplyNaming</code> 的命令号为 -32206(0x32 0x82)，内容由</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kt">byte</span> <span class="n">bTime</span> <span class="o">=</span> <span class="p">((</span><span class="kt">byte</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="n">dwUserID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">byteBuffer</span><span class="p">.</span><span class="na">putInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">dwUserID</span><span class="p">);</span>
<span class="n">byteBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">bTime</span><span class="p">);</span>
</code></pre></div>

<p>可见先是 i32 的 dwUserID，然后是 i8 的 bTime。</p>
<p>再看一下调用的代码可以看出来 dwUserID 是加入课堂时会由 <code>NotifyJoinMeeting</code>(-32254) 分配的 ID，
bTime 是签到所花的秒数。</p>
<h3>修改网络</h3>
<p>先要让网络经过 nftable，我最初用的是 arp 攻击，后来直接让主机作为虚拟机的网关。</p>
<p>建一个 tap，此处虚拟机网段为 192.168.2.0/24 ：</p>
<div class="highlight"><pre><span></span><code>ip tuntap add dev tap0 mode tap user <span class="nv">$USER</span>
ip addr add <span class="m">192</span>.168.2.1/24 scope link dev tap0
ip link <span class="nb">set</span> tap0 up
</code></pre></div>

<p>虚拟机设置为桥接网络，桥接在 tap0 上。</p>
<p>在把所有发往 9980 的端口劫持了（以主机地址为 192.168.1.200 为例）：</p>
<div class="highlight"><pre><span></span><code>table ip nat {
  chain prerouting {
    type nat hook prerouting priority 0;
    ip saddr 192.168.2.0/24 tcp dport 9980 dnat to 192.168.1.200;
  }
}
</code></pre></div>

<p>接下来再在主机上启动一个监听 9980 端口的程序，并把收到的数据（做些修改的）转发到课后网的服务器上。
这个程序在收到 <code>NotifyJoinMeeting</code>(-32254) 时记录下 UserID，
在收到 <code>RequestNaming</code>(-32207) 时回复 <code>ReplyNaming</code>(-32206)。</p>
<h3>获取 ip</h3>
<p>上一节所说的中间程序需要连接到课后网的服务器上，但是据我观察，课后网的服务器地址每节课是不一样的。</p>
<p>所以我就加了一个程序，抓取课后网试图连接的服务器的 ip 地址发送给这个中间程序，这就是我的代码中 <code>pcap_server.rb</code> 的用处。</p>
    </div>

    <div class="post_list">
      <span>By </span>
      <a href="https://blog.yahvk.ml/author/yahvk.html">@yahvk</a>
      <span> in </span>
      <span class="post_category">
        <a href="https://blog.yahvk.ml/category/reverseengineering.html" rel="bookmark" title="Permalink to reverseengineering">
          [ reverseengineering ]
        </a>
      </span>

      <span class="post_date">五 17 四月 2020</span>
      <div><span>Tags : </span>
        <span><a href="https://blog.yahvk.ml/tag/kehou.html">#kehou, </a></span>
      </div>

      <br>

      <div class="entry-social">
        <span class="twitter">
          <a target="_blank" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;" title="Twitter" href="https://twitter.com/share?url=https://blog.yahvk.ml/po-jie-ke-hou-wang.html&text=破解课后网&via=yahvk_cuna">
            <img src="https://blog.yahvk.ml/theme/images/icons/twitter-s.png">
          </a>
        </span>

        <span class="gplus">
          <a target="_blank" title="Google +" href="https://plus.google.com/share?url=https://blog.yahvk.ml/po-jie-ke-hou-wang.html&hl=fr" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;">
            <img src="https://blog.yahvk.ml/theme/images/icons/google-s.png">
          </a>
        </span>

        <span class="facebook">
          <a target="_blank" title="Facebook" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;" href="https://www.facebook.com/sharer.php?u=https://blog.yahvk.ml/po-jie-ke-hou-wang.html&t=破解课后网">
            <img src="https://blog.yahvk.ml/theme/images/icons/facebook-s.png">
          </a>
        </span>

        <a target="_blank" title="Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://blog.yahvk.ml/po-jie-ke-hou-wang.html&title=破解课后网" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;">
          <img src="https://blog.yahvk.ml/theme/images/icons/linkedin-s.png">
        </a>

        <span class="mail">
          <a href="mailto:?subject=破解课后网&amp;body=在 yahvk 的网站上发现有关 [破解课后网] 的文章。 https://blog.yahvk.ml/po-jie-ke-hou-wang.html" title="Share by Email" target="_blank"><img src="https://blog.yahvk.ml/theme/images/icons/mail-s.png">
          </a>
        </span>
      </div>
    </div>

      <a href="https://blog.yahvk.ml/bian-cheng-ji-chu-0-mu-lu.html"
      class="change-page left">
        &lt;  编程基础（0）——目录
      </a>
      <a href="https://blog.yahvk.ml/xiu-fu-tu-dou-wen-jie-ma-qi.html"
        class="change-page right">
        修复土豆文解码器  &gt;
      </a>
    <hr style="margin-top: 70px;">
    <h2 style="text-align: center; margin: 15px 0 0 0;">选一个评论框评论？</h2>
    <div class="comment">
      <script>
        var switch_comment = function (name) {
          if (name === 'disqus') {
            document.getElementById('disqus_thread').style.display="block";
            document.getElementById('gitalk').style.display="none";
            document.getElementById('disqus_comment').style.background="#ff7300";
            document.getElementById('disqus_comment').style.color="#fff";
            document.getElementById('gitalk_comment').style.background="#ddd";
            document.getElementById('gitalk_comment').style.color="#000";
          } else if (name === 'gitalk') {
            document.getElementById('disqus_thread').style.display="none";
            document.getElementById('gitalk').style.display="block";
            document.getElementById('disqus_comment').style.background="#ddd";
            document.getElementById('disqus_comment').style.color="#000";
            document.getElementById('gitalk_comment').style.background="#ff7300";
            document.getElementById('gitalk_comment').style.color="#fff";
          }
        };
      </script>
      <ul class='comment_switch_head'>
        <li id="disqus_comment">
          <button class="comment_switch" onclick="switch_comment('disqus')">Disqus</button>
        </li>
        <li id="gitalk_comment">
          <button class="comment_switch" onclick="switch_comment('gitalk')">Gitalk</button>
        </li>
      </ul>
      <!-- DISQUS BEGIN -->
        <div id="disqus_thread"></div>
        <script data-cfasync="false" type="text/javascript">
          var disqus_config = function () {
            this.page.identifier = "po-jie-ke-hou-wang.html";
          };
          (function () {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = 'https://71e6fd52s-blog.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] ||
              document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      <!-- DISQUS END -->
      <!-- GITALK BEGIN -->
        <div id="gitalk"></div>
          <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
        <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
        <script>
          const gitalk = new Gitalk({
            clientID: 'cc78bf6b5758fd53a38a',
            clientSecret: '96acad33ae8646e60b8f0bfd7d1c99e24f7a7caf',
            repo: 'blog',
            owner: '71e6fd52',
            admin: ['71e6fd52'],
            id: 'po-jie-ke-hou-wang.html',
            distractionFreeMode: true
          })

          gitalk.render('gitalk')
        </script>
      <!-- GITALK END -->
    </div>

  </article>
</section>
</article>

<!-- Footer -->
    <footer>
        <p>
          使用 <a href="https://python.org">Python</a> 制成的 <a href="https://getpelican.com/">Pelican</a> 构建。
          主题为 yahvk 修改过的 <a href="https://github.com/71e6fd52/pelican-blue">Pelican-Blue</a>。
          <br />
          除特殊说明以外，本网站原创内容采用<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a>进行许可。
        </p>
    </footer>


</body>
</html>